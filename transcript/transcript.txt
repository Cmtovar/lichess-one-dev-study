Lee chess is a chess platform that
supports 5.2 million chess games a day
with a single core developer it's a
massive platform built with a pretty
unusual stack including some
technologies that you may have never
heard of like Scala and snab doom this
is an incredibly productive developer
and the technology plays at least a
small part in enabling these massive
gains before we dive into the stack let
me share a short anecdote to set the
landscape for online chess this is
Vladimir kramnick he defeated krie
Kasparov to become the world chess
champion in 2000 and defended that title
to remain the best player in the world
until 2006 at his Peak he was the
Undisputed best player in the world but
lately he's better known for the
accusations he makes on Twitter after
comparing the over theboard and online
statistics of some high-rated players he
came to the conclusion that they must be
cheating eventually resulting in a
tournament called The Clash of claims
after kramnick accused Grandmaster Jose
Martinez of cheating chess.com offered
to be part of a tournament where they
would play over theboard and online
games to determine whether Martinez was
in fact cheating obviously this
tournament is completely useless because
people who are good at something can
still cheat but everyone agreed to go
ahead with it anyway with a few
conditions very concerned about cheating
kramnick demanded that brand new laptops
be opened every morning before the
online games because of the way time
zones were configured on the brand new
laptops the chess clock which is just a
simple countdown timer shown on kramnick
screen was off by over 30 seconds this
makes a huge difference in a 3-minute
game there are many systems we could
blame for this issue the operating
system JavaScript time zones all of
these are terrible aor prone things that
we have created but because it fits my
narrative I'm going to say that one of
the 138 Engineers working at chess.com
should have been able to Wrangle these
three systems together and create a
working timer especially since the
single engineer who built Lee chest
doesn't have this issue chess.com is the
biggest chess platform in the world it
is a multi-million dollar company with
over 700 employees users can play a
variety of Chess modes online request an
engine review of their games complete
puzzles analyze positions using an
engine and play against AI most of these
features are premium and will be limited
without a monthly membership leeches is
for second biggest chess platform it is
an open-source hobby project created by
tibo dupy only chess users can play a
variety of Chess modes online request an
engine review of their games complete
puzzles analyze positions and play
against AI all completely for free now
it's not like he's done this all by
himself right well honestly he kind of
has the core repository has 430
contributors but a quick look at the
contribution graph shows that this man
is the single driver force behind liees
for years his was the only salary paid
for by the liees organization a very
modest salary given the quality of his
work today liees pays two salaries one
for TBO and one for someone to maintain
the mobile application this is
incredibly impressive One Core developer
supports 5.2 million chess games a day
including the two mentioned salaries
liees cost
liees cost $517,000 185
$517,000 185
$517,000 185 am10 a year to run for stack is Scala
am10 a year to run for stack is Scala
mongodb snapd typescript and SAS which
all run on a bare metal server in France
this is not a very common stack but with
such a small team creating such a
massive product TBO has prioritized
small simple tools that focus on
long-term developer experience and give
the best value for money Scala is the
language that powers most of Le chess it
was chosen because it is strongly typed
expressive high level functional and has
the ability to leverage of a massive jvm
ecosystem Scala is not a popular choice
by any stretch of the imagination I
would wager that a significant number of
viewers would have never heard of Scala
and an even fewer number ever written it
Scala is a response to the issues
commonly found in Java mainly too much
boiler plate and the lackluster type
system it aims to be succinct with
better support for functional patterns
while still being compatible with the
jvm it is expressive scalable and safe
it supports both both object orientation
and functional programming it is
extremely concise and its type system is
a huge improvement over other jvm
languages I still can't believe that
Java and cotlin both have no Union types
Scala also has the nice enums that can
store values and be used for patent
matching it shares many features with
popular functional languages like
currying immutability lazy evaluation
and pattern matching you can think of
Scala as a middle ground between High
school and Java colon or as Haso with
more side effects the name Scala comes
from scalable language this is a
language that is designed to grow with
the needs of its users here's what T has
to say about why he chose Scala first of
all it is strongly typed emphasis on
strongly then Scala has decent support
for functional programming no mutability
no side effects since liees is a big
beast we don't have a lot of Manpower
and I'm not the brightest star we then
need a lot of help from the language and
compiler in order to scale in complexity
Scala gives us that has school has
similar properties but Scala runs on the
jvm and benefits from the entire Java
ecosystem and that's what made the
difference TBO has said that if he had
to start over he would seriously
consider hasool but he originally chose
Scala because of a jvm and would likely
make the same Choice today has is an
excellent language that much like Scala
is also strongly typed expressive high
level and functional each of these
requirements helps the tiny team deliver
a huge product the strong type system
allows for easy Carefree refactoring
expressive syntax allows for features to
be developed with less code the
functional Paradigm reduces side effects
which keeps code clear and easy to
reason about leeches uses the play
framework this is an MVC framework
specifically for Scala applications but
TBO has mentioned that this is one of
the technologies that he regrets
adopting Leela is built on the play
framework it made sense originally to
speed up development with a cohesive and
opinionated set of libraries that work
together a framework but as years went
and Leela got bigger it outgrew the
framework and we would now be better off
with smaller independent libraries that
we can swap as needed so instead of a
framework I would now be looking at one
library for HTTP another one for routing
another one for HTTP forms Json and so
on
on mongodb is a very flexible document
mongodb is a very flexible document
storage database if you haven't heard of
mongodb before it's basically like
storing Json objects in a queriable way
mongodb is a database that does this in
a resilient and efficient way it makes
it very easy to get started since you
don't have to think about database
modeling as you would in a relational
database you save your objects usually
exactly as they are in your code and the
database manages for related queries
liees chose because it is fast
robust easy to use and has good
compression its biggest disadvantage is
that it can be very expensive I know
firsthand that mongod DB Atlas can come
with crippling costs especially with a
growing data set and although storage is
still the biggest server expense the
fact that LE chess is self-hosted helps
mitigate this cost document storage
works well for chess games although TBO
feels that mongod DB itself is not a key
to his success mongod DB is serving us
well and I'm happy with it it's
currently juggling with 5.5 billion
games and about 15 billion other
documents and serving tens of thousands
of queries per second it's fast
compresses the data and replicates
seamlessly for redundancy and data
safety its aggregation framework allows
the complex data queries that leeches
needs if we had to remake that choice we
would probably go for postgressql
because it can also do all that and it's
released under an open-source license
choosing between document storage and a
relational database is a personal and
semi-permanent choice they can both
serve most applications so choose
whatever your most comfortable with
migrations are very painful but nosql
and SQL are both extremely versatile
leeches also uses Reddit to communicate
between Services most notably the
websocket service saves events to a
redis cache which are then read by the
core service which is named Lea we'll
talk about the overall architecture a
little later but it's not a single
monolith and it's not all microservices
I can't confirm since the deployment of
Leela is not public but I have a feeling
that this red is cache is what allows
leest to be deployed multiple times a
week without downtime since for
websocket connections can keep state in
the cache which can be read by the new
version given tibo has mentioned he
prefers static typing it shouldn't be
much of a surprise but the front end of
liees uses typescript typescript
provides a strong type system for the
front end much like the back end this
allows for easy refactoring and
maintenance since the compiler is doing
a lot of a heavy lifting for you for a
long time leest was using myth. JS a
tiny JS framework with a focus on
Simplicity due to its growing complexity
they eventually moved to snapd a virtual
Dom library with an even greater focus
on Simplicity here's what tore had to
say about front- end Frameworks oh my
did I love myal it's such a breath of
fresh air virtual Dom Done Right simple
and a beautiful API fast Pastime and
runtime The Love Story lasted a couple
years then I realized that snab Doom was
pushing it all a bit further simpler
smaller faster myth roll 2 improved
performance but at the cost of
complexity using element caches I'm glad
that snab Doom didn't go that way it
makes it more stable and predictable
most popular front- end Frameworks in
libraries come packed with features not
all of which you always need some of
these features usually include State
Management life cycle methods Js SE
syntax and a virtual dom snab dom takes
an unopinionated approach the call
module comes with a great virtual Dom
and nothing else it's dead simple but
it's also extremely fast and versatile
all the extra functionality that you are
forced to use with other libraries can
be opted into by adding modules it's
usually not reasonable to use raw
JavaScript or raw jQuery especially for
big projects snap Dom gives you the most
important part of the big framework the
virtual Dom without the massive
dependencies that usually come bundled
in this shows how important Simplicity
is to liees especially on the front end
where things can get out of hand fast
while many front-end developers tend to
add dependencies to try and solve issues
TBO is actively trying to reduce them
even when the existing framework is one
of the smallest Frameworks available
lees's front end is by no means perfect
but the Bland look is an intentional
Choice by the developer rather than the
limitation of a Project's dependencies
even t-o ad that there is a lot to
improve on but he chooses to focus on ux
instead of UI since that is more
important I did most of the UI myself
I'm a programmer not a designer that's
why it's always been quite Bland with no
images and very little colors I made up
for my lack of UI skills by focusing on
ux user experience and I think it paid
off Lees uses SAS to manage CSS although
tibo isn't thrilled with it SAS is
annoying but that's just because CSS is
annoying I wonder if he would like
Tailwind it seems like a natural
compliment to his current stack although
I've never seen him comment on it the
leeches architecture can be described as
a monolith with satellites the main
server Leela is a massive monolith some
smaller services like stockfish analysis
and web sockets are split into separate
servers this is not a state of
transition this is a great way to
leverage for strengths and weaknesses of
both monoliths and microservices Leela
comes with the convenience of a monolith
it's convenient because all the state is
in one place and can be cached in Heap
for all modules of the site to use which
makes it very efficient and quick at
runtime everything compiles as a single
unit which ensures that the entire site
is coherent and free of
incompatibilities the disadvantage is
that it becomes a single point of
failure for the whole system tibo splits
part of a code that they would like to
deploy separately into their own servers
so that they can be deployed and even
fail without affecting the most
important service the current state of
things is a result of years of evolution
there was no master plan we just looked
at monitoring to figure out what needed
scaling I like where it's at but to be
honest I'm biased by the fact that it's
the only large co-base I've been working
on for years so I lack experience with
different ways of doing things that I
could compare it to maybe being able to
deploy Leela over multiple servers for
resilience would be nice but then we'd
lose the ability to cash in Heap because
proper cash and validation across
multiple instances would be impossible
the performance and complexity
implications have deterred me from
trying it out so far that's right Leela
runs on a single server managed by a
company called ovh a single server means
that all the state can be stored in
memory allowing processing to be much
faster lag can play an important role in
chess games especially when flagging in
bullet Lee chess addresses this with lag
compensation and optimistic clients side
rendering which means that even here in
a Australia the experience is fluid this
solution only works because chess is a
turn-based game but Lee chess can
Leverage The Simplicity of a single
server to be very performant here's the
architecture of leeches all the gray
boxes are physical server computers in a
data center the leeches team manages
everything on these computers down to
what Linux distribution is installed
they used to use Arch Linux but migrated
to iunu although distributions also seem
to be something that isn't really
important yes the applicative and
database servers used to run on Arch
Linux like 4 years ago every software
upgrade was quite scary and we had some
downtime absolutely not blaming arch for
this it's a great distribution that I'm
still happily running on my laptop it's
just not the best choice for servers
nowadays leeches servers run on Ubuntu
it could be Debian just the same but we
keep installing Ubuntu for the sake of
consistency Manta is the biggest machine
and runs for main monolith around this
is the services and many database
replicas there isn't a lot of
information about the deployment process
of the monor repo but we can see from
some of the microservices that they Tred
to keep things as simple as possible
this is obvious when looking at the
deployment script for Leela WS which is
arguably the second most important
service it's just a script that uses R
sync to dump the files on the new server
and then SSH into it to deploy the new
version some of these side services use
other languages when necessary Neary the
red services are written in Scala while
the orange ones are written in Rust the
rust services are usually smaller
services with high performance
requirements leeches is a web app but it
also has an Android and iOS application
this is the only part of the system that
has a separate dedicated developer
salary the mobile app used to use ironic
capacitor but the team decided to move
to flut and recreate a whole dedicated
application to provide a better user
experience using flutter makes sense for
this team since it is open- source and
multiplatform this project is much more
than the sum of ITS Technologies tools
aren't everything this project succeeded
not because of its stack but because of
the dedication and hard work of its
founder for developer mindset throughout
its life has also played a huge part in
its ability to succeed with so little
resources t-bo is obsessed with
Simplicity with each new line of code
we're adding maintenance burden for
years to come compatibility with the
rest of the site with the mobile app
migrations through new libraries and
language versions refactoring the code
itself redesigning the UI it is a part
of the new line of code will need to be
Revisited many times adding time and
risks to every code modification that
affects It lines of code are not
valuable they are a cost that is not
paid while writing them but while
maintaining them sometimes years later
and they pile up adding lines of code to
a program is like adding weight to an
airplane it better be worth it this
Simplicity which is prevalent throughout
the entire program is a key to its
success the developer isn't trying to
shove as many features as possible into
the code base but trying to grow it in a
sustainable way Tech debt is the biggest
frustration for developers according to
the stack Overflow developer survey this
year but Lees has very little of it
since there is no product team there is
no one to push back on doing things
right the first time around or going
back and fixing past issues I didn't shy
away from Chang ing parts of a stack I
didn't like even when it took weeks or
months it's one of the props of a
project led by its developer there was
no one to tell me that something is more
important than clearing away Tech de
reading and listening to TBO it is so
evident that he is one of the most
humble people you could meet in a field
that is often governed by Hot Heads and
strong opinions he is a breath of fresh
air he is an extremely hardworking
programmer who could be making much more
money by working on a for-profit project
project but he chooses to work on Le
chess and pays himself a very modest
salary because money is not important
he's happy doing what he loves and
traveling the world this is perhaps the
best lesson to learn from Lee chess
there's more to life than working at
Fang or selling your startup there's so
much joy to be had on working on your
craft and making delightful products
even at the cost of potentially more
money it would be a disservice to tore
and to liees if I didn't mention the
open- source identity of a platform
openness is perhaps the core value of
liees the product was open source from
day one and the first features were
implemented after TBO communicated with
a user who stumbled onto his hobby
project there's no bigger goal to take
your money or sell your data or even
show you ads liees is just a great
product because building great products
is rewarding for its author there are
many possible lessons to be learned from
studying tore and liees and I hope to
learn a lot from this incredibly
impressive project here are some of my
personal takeaways Simplicity it's
important to be afraid of features code
is a necessary evil and the best code is
no code at all great programmers do less
less of everything fewer dependencies
fewer features fewer lines fewer
abstractions fewer patterns when one of
the smallest JavaScript Frameworks
started growing in complexity they moved
to an even smaller and more flexible
framework he regrets using the play
framework because it has too many
features he doesn't need and when when
he migrates he does it correctly and
completely minimizing Tech debt is much
more important than exploring new
features do it right the first time or
take the time to do it right the second
there's nothing more dangerous than
growing Tech debt I've been a part of
many projects where there is a legacy
service that everyone refuses to touch
but don't live with tech de fix it
before it slows you down to a crawl
don't mess with the front end keep it as
minimal as possible and move as much
logic as possible to the back end
JavaScript is is dangerous ux is more
important than UI be deliberate about
which features go where and don't add
features that do not have a logical
place in the UI database Technologies
need to be robust and scalable but other
than that don't stress too much about
what you use use something that is tried
and tested and stick with it don't over
complicate things tooling at the end of
the day it's important to use the right
tool for the right job a functional high
level language like Scala is a great
tool for a massive code base with lots
of moving Parts a low-level performant
language like rust is perfect for
smaller services that need to go fast
you need to use tools you're comfortable
with but you also need to be ready to
step out of your comfort zone if massive
gains are up for grabs it would have
taken the leeches team much more time to
optimize Scala enough to match rust
performance than to just write these
smaller services in Rust it's also
important to let the tools make your
life easier long term TBO chooses tools
that work for him by using static typing
and functional paradigms he moves as
much of a complexity to compile time as
possible freeing him to think about the
actual problems TBO expects that he will
make mistakes and plans accordingly a
common thing he says is that his job is
to fix yesterday's bugs and create new
bugs or features for tomorrow I love
this mindset I don't think he's
relinquishing responsibility but he
expects that mistakes will happen and
he's ready to fix them when they do no
one writes perfect code so be patient
with yourself and try to set yourself up
to fix bugs quickly lifestyle status
Rank and salary aren't as important as
the value you're delivering and how
happy you are in life improve your craft
not because it will get you promoted but
because it's fun to create things and
when you do create things don't be
afraid to share them with the world
don't be greedy with your talents
software is built on openness and the
more we collaborate the more cool things
we can create the last thing I want to
do is plug the leeches patreon their
website is completely open and funded by
donations TBO Des every cent but he's
kept his salary so low that most
donations will go towards building a
better product anyway thanks for